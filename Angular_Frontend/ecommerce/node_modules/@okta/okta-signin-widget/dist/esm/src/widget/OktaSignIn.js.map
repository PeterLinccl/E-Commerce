{"version":3,"file":"OktaSignIn.js","sources":["../../../../src/widget/OktaSignIn.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { ConfigError } from 'util/Errors';\nimport Util from 'util/Util';\nimport Logger from 'util/Logger';\nimport getAuthClient from 'widget/getAuthClient';\nimport buildRenderOptions from 'widget/buildRenderOptions';\nimport createRouter from 'widget/createRouter';\nimport Hooks from 'models/Hooks';\nimport {\n  WidgetOptions,\n  WidgetOktaAuthConstructor,\n  WidgetOktaAuthInterface,\n  OktaSignInAPI,\n  RenderSuccessCallback,\n  RenderErrorCallback,\n  RenderResult,\n  RenderOptions,\n  HookFunction,\n  RenderResultSuccess,\n  EventCallback,\n  EventCallbackWithError,\n  EventName,\n  RouterClassFactory,\n  AbstractRouter,\n  RouterConstructor\n} from '../types';\nimport { Tokens } from '@okta/okta-auth-js';\n\nconst EVENTS_LIST = ['ready', 'afterError', 'afterRender'];\n\nexport function createOktaSignIn\n(\n  authClientConstructor: WidgetOktaAuthConstructor,\n  routerClassFactory: RouterClassFactory\n)\n{\n  return class OktaSignIn implements OktaSignInAPI {\n    Router: RouterConstructor;\n    options: WidgetOptions;\n    hooks: Hooks;\n    router: AbstractRouter;\n    authClient: WidgetOktaAuthInterface;\n\n    constructor(options: WidgetOptions) {\n      Util.debugMessage(`\n          The Okta Sign-In Widget is running in development mode.\n          When you are ready to publish your app, embed the minified version to turn on production mode.\n          See: https://developer.okta.com/code/javascript/okta_sign-in_widget#cdn\n        `);\n\n      this.options = options;\n      this.authClient = getAuthClient(authClientConstructor, options);\n\n      // validate authClient configuration against widget options\n      if (options.useClassicEngine !== true && this.authClient.options.clientId && this.authClient.isPKCE() === false) {\n        throw new ConfigError(\n          'OAuth2 with interaction code flow requires PKCE to be enabled on the authClient.'\n        );\n      }\n\n      // Hooks can be modified before or after render\n      this.hooks = new Hooks({\n        hooks: options.hooks\n      });\n\n      this.Router = routerClassFactory(options);\n\n      // Triggers the event up the chain so it is available to the consumers of the widget.\n      this.Router.prototype.Events.listenTo.call(this, this.Router.prototype, 'all', this.trigger);\n\n      // On the first afterRender event (usually when the Widget is ready) - emit a 'ready' event\n      this.once('afterRender', function(context) {\n        this.trigger('ready', context);\n      });\n    }\n\n    /**\n     * Render the sign in widget to an element. Returns a promise that will resolve on success or reject on error.\n     * @param options - options for the signin widget.\n     *        Must have an el or $el property to render the widget to.\n     * @param success - success callback function\n     * @param error - error callback function\n     */\n    renderEl(renderOptions: RenderOptions, successFn?: RenderSuccessCallback, errorFn?: RenderErrorCallback): Promise<RenderResult> {\n      if (this.router) {\n        throw new Error('An instance of the widget has already been rendered. Call remove() first.');\n      }\n\n      const res = createRouter(this.Router, this.options, renderOptions, this.authClient, successFn, errorFn, this.hooks);\n      this.router = res.router;\n      return res.promise;\n    }\n\n    \n    hide(): void {\n      if (this.router) {\n        this.router.hide();\n      }\n    }\n\n    show(): void {\n      if (this.router) {\n        this.router.show();\n      }\n    }\n\n    remove(): void {\n      if (this.router) {\n        this.router.remove();\n        this.router = undefined;\n      }\n    }\n\n    /**\n     * Renders the Widget and returns a promise that resolves to OAuth tokens\n     * @param options - options for the signin widget\n     */\n    showSignInToGetTokens(options?: RenderOptions): Promise<Tokens> {\n      const renderOptions = Object.assign(buildRenderOptions(this.options, options), {\n        redirect: 'never'\n      });\n      const promise = this.renderEl(renderOptions).then(res => {\n        return (res as RenderResultSuccess).tokens;\n      });\n      const authClient = this.router.settings.getAuthClient();\n      if (authClient.isAuthorizationCodeFlow() && !authClient.isPKCE()) {\n        throw new ConfigError('\"showSignInToGetTokens()\" should not be used for authorization_code flow. ' + \n          'Use \"showSignInAndRedirect()\" instead');\n      }\n      return promise;\n    }\n\n    /**\n     * Renders the widget and redirects to the OAuth callback\n     * @param options - options for the signin widget\n     */\n    showSignInAndRedirect(options?: RenderOptions): Promise<void> {\n      const renderOptions = Object.assign(buildRenderOptions(this.options, options), {\n        redirect: 'always'\n      });\n      return this.renderEl(renderOptions).then(() => {\n        // This method should never return, it will either redirect or reject with error\n        return;\n      });\n    }\n\n    /**\n     * Renders the widget. Either resolves the returned promise, or redirects.\n     * @param options - options for the signin widget\n     */\n    showSignIn(options?: RenderOptions): Promise<RenderResult> {\n      const renderOptions = Object.assign(buildRenderOptions(this.options, options));\n      return this.renderEl(renderOptions);\n    }\n\n    // Hook convenience functions\n    before(formName: string, callbackFn: HookFunction): void {\n      this.hooks.mergeHook(formName, {\n        before: [\n          callbackFn\n        ]\n      });\n    }\n\n    after(formName: string, callbackFn: HookFunction): void {\n      this.hooks.mergeHook(formName, {\n        after: [\n          callbackFn\n        ]\n      });\n    }\n\n    getUser(): any {\n      return this.router?.appState?.getUser();\n    }\n    \n    // Events API\n\n    on(event: EventName, callback: EventCallback | EventCallbackWithError): void {\n      // custom events listener on widget instance to trap third-party callback errors\n      if (EVENTS_LIST.includes(event)) {\n        const origCallback = callback;\n        callback = function(...callbackArgs) {\n          try {\n            origCallback.apply(this, callbackArgs);\n          } catch (err) {\n            Logger.error(`[okta-signin-widget] \"${event}\" event handler error:`, err);\n          }\n        };\n      }\n      this.Router.prototype.Events.on.call(this, event, callback);\n    }\n\n    off(event?: EventName, callback?: EventCallback | EventCallbackWithError): void {\n      this.Router.prototype.Events.off.call(this, event, callback);\n    }\n\n    once(event: EventName, callback: EventCallback): void {\n      this.Router.prototype.Events.once.call(this, event, callback);\n    }\n\n    stopListening(event?: EventName, callback?: EventCallback): void {\n      this.Router.prototype.Events.stopListening.call(this, event, callback);\n    }\n\n    listenTo(object: any, event: EventName, callback: EventCallback): void {\n      this.Router.prototype.Events.listenTo.call(this, object, event, callback);\n    }\n\n    trigger(event: EventName, ...args: any[]): void {\n      this.Router.prototype.Events.trigger.apply(this, [event, ...args]);\n    }\n\n  };\n}\n"],"names":["EVENTS_LIST","createOktaSignIn","authClientConstructor","routerClassFactory","OktaSignIn","constructor","options","Router","hooks","router","authClient","Util","debugMessage","getAuthClient","useClassicEngine","clientId","isPKCE","ConfigError","Hooks","prototype","Events","listenTo","call","trigger","once","context","renderEl","renderOptions","successFn","errorFn","Error","res","createRouter","promise","hide","show","remove","undefined","showSignInToGetTokens","Object","assign","buildRenderOptions","redirect","then","tokens","settings","isAuthorizationCodeFlow","showSignInAndRedirect","showSignIn","before","formName","callbackFn","mergeHook","after","getUser","appState","on","event","callback","includes","origCallback","callbackArgs","apply","err","Logger","error","off","stopListening","object","args"],"mappings":"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"}